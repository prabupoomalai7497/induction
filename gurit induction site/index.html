<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Industrial Induction LMS</title>
  <style>
    /* ===== CSS VARIABLES FOR THEMING ===== */
    :root {
      --primary-color: #1e3c72;
      --secondary-color: #2a5298;
      --accent-color: #4a6fc7;
      --text-color: #333;
      --bg-color: #f5f7fa;
      --card-bg: #ffffff;
      --border-color: #e1edff;
      --success-color: #2d8f5a;
      --warning-color: #e6a700;
      --danger-color: #d32f2f;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --radius: 8px;
      --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      --primary-color: #2a5298;
      --secondary-color: #4a6fc7;
      --accent-color: #6b8de3;
      --text-color: #f0f0f0;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --border-color: #333;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* ===== BASE STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: var(--transition);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== TOPBAR STYLES ===== */
    .topbar {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .brand-logo {
      width: 50px;
      height: 50px;
      background: white;
      color: var(--secondary-color);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
      overflow: hidden;
    }

    .brand-text h1 {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }

    .brand-text p {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .topnav {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .nav-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .nav-btn-active {
      background: white;
      color: var(--secondary-color);
    }

    .theme-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 1rem;
      transition: var(--transition);
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ===== MAIN AREA STYLES ===== */
    .main-area {
      flex: 1;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    /* ===== CARD STYLES ===== */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      margin-bottom: 2rem;
      transition: var(--transition);
    }

    .card-header-inline {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .card h2 {
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    .info {
      background: rgba(30, 60, 114, 0.05);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      border-left: 4px solid var(--primary-color);
    }

    .info.small {
      font-size: 0.9rem;
      padding: 0.8rem;
    }

    /* ===== FORM STYLES ===== */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .form-full-width {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    input[type="text"],
    input[type="password"],
    input[type="date"],
    input[type="number"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      transition: var(--transition);
      background: var(--card-bg);
      color: var(--text-color);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(74, 111, 199, 0.2);
    }

    /* ===== BUTTON STYLES ===== */
    .btn-primary {
      background: var(--secondary-color);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-primary:hover {
      background: var(--primary-color);
    }

    .btn-secondary {
      background: rgba(30, 60, 114, 0.05);
      color: var(--secondary-color);
      border: 1px solid var(--secondary-color);
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-secondary:hover {
      background: rgba(30, 60, 114, 0.1);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .btn-disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-disabled:hover {
      background: #ccc;
    }

    /* ===== CHECKBOX STYLES ===== */
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      cursor: pointer;
    }

    .checkbox-row input {
      margin-right: 0.8rem;
      width: 18px;
      height: 18px;
    }

    /* ===== BADGE STYLES ===== */
    .badge {
      background: var(--secondary-color);
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .badge-soft {
      background: rgba(30, 60, 114, 0.1);
      color: var(--secondary-color);
    }

    .badge-success { background: var(--success-color); }
    .badge-warning { background: var(--warning-color); }
    .badge-danger  { background: var(--danger-color); }

    /* ===== MODULE GRID STYLES ===== */
    .module-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .module-grid.small {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }

    .module-card {
      background: rgba(30, 60, 114, 0.03);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .module-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--accent-color);
    }

    .module-card h3 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .module-card p {
      color: var(--text-color);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      opacity: 0.8;
    }

    .module-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-color);
      margin-top: 1rem;
      opacity: 0.7;
    }

    .module-thumbnail {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 1rem;
      background: #e1edff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--secondary-color);
      font-weight: bold;
    }

    .module-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* ===== TRAINING SECTION STYLES ===== */
    .section-title {
      color: var(--primary-color);
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .video-wrapper {
      position: relative;
      margin-bottom: 1.5rem;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      background: #000;
    }

    video {
      width: 100%;
      display: block;
    }

    /* ===== QUIZ STYLES ===== */
    .quiz-list { margin-bottom: 2rem; }

    .quiz-question {
      background: rgba(30, 60, 114, 0.03);
      padding: 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      border-left: 4px solid var(--primary-color);
    }

    .quiz-question h4 {
      margin-bottom: 1rem;
      color: var(--primary-color);
    }

    .quiz-option {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .quiz-option input { margin-right: 0.8rem; }

    .quiz-timer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.8rem;
      background: rgba(230, 167, 0, 0.1);
      border-radius: 4px;
      border-left: 4px solid var(--warning-color);
    }

    .quiz-result {
      padding: 1rem;
      border-radius: var(--radius);
      margin-top: 1.5rem;
      text-align: center;
      font-weight: 500;
      font-size: 1.1rem;
    }

    .quiz-pass {
      background: rgba(45, 143, 90, 0.1);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }

    .quiz-fail {
      background: rgba(211, 47, 47, 0.1);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
    }

    /* ===== RESULT SECTION STYLES ===== */
    #resultBox { text-align: center; padding: 2rem; }

    .result-icon { font-size: 4rem; margin-bottom: 1rem; }

    .result-pass .result-icon { color: var(--success-color); }
    .result-fail .result-icon { color: var(--danger-color); }

    .result-score {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 1rem 0;
    }

    .result-pass .result-score { color: var(--success-color); }
    .result-fail .result-score { color: var(--danger-color); }

    .result-actions {
      margin-top: 2rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    /* ===== CERTIFICATE STYLES ===== */
    .certificate {
      background: white;
      border: 10px solid gold;
      padding: 2rem;
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
      position: relative;
    }

    .certificate-header { margin-bottom: 2rem; }
    .certificate-body  { margin: 2rem 0; }

    .certificate-footer {
      margin-top: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .qr-code {
      width: 120px;
      height: 120px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
    }

    /* ===== ADMIN STYLES ===== */
    .admin-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }

    .admin-tab {
      background: none;
      border: none;
      padding: 1rem 1.5rem;
      cursor: pointer;
      font-size: 1rem;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      white-space: nowrap;
    }

    .admin-tab:hover {
      background: rgba(30, 60, 114, 0.05);
    }

    .admin-tab-active {
      color: var(--secondary-color);
      border-bottom-color: var(--secondary-color);
      font-weight: 500;
    }

    .admin-tab-panel { display: block; }

    /* ===== STATS STYLES ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      animation: popIn 0.5s ease-out;
    }

    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .stat-label {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      opacity: 0.8;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--secondary-color);
    }

    /* ===== TABLE STYLES ===== */
    .results-toolbar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    #resultsSearch {
      width: 300px;
      padding: 0.7rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--card-bg);
      color: var(--text-color);
    }

    .table-wrapper { overflow-x: auto; }

    .results-table {
      width: 100%;
      border-collapse: collapse;
    }

    .results-table th,
    .results-table td {
      padding: 0.8rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .results-table th {
      background: rgba(30, 60, 114, 0.05);
      font-weight: 500;
    }

    .results-table tr:hover {
      background: rgba(30, 60, 114, 0.03);
    }

    .pass-badge {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .pass-badge.pass {
      background: rgba(45,143,90,0.1);
      color: var(--success-color);
    }
    .pass-badge.fail {
      background: rgba(211,47,47,0.1);
      color: var(--danger-color);
    }

    /* ===== QUESTION SET STYLES ===== */
    .question-set {
      background: rgba(30,60,114,0.03);
      padding: 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-color);
    }

    .question-set-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .question-set-title {
      font-weight: 500;
      color: var(--primary-color);
    }

    .btn-remove {
      background: rgba(211,47,47,0.1);
      color: var(--danger-color);
      border: 1px solid var(--danger-color);
      padding: 0.3rem 0.7rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .btn-remove:hover { background: rgba(211,47,47,0.2); }

    /* ===== SETTINGS STYLES ===== */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .color-picker {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: var(--transition);
    }

    .color-option.active { border-color: var(--text-color); }

    .error {
      color: var(--danger-color);
      background: rgba(211,47,47,0.1);
      padding: 0.8rem;
      border-radius: 4px;
      margin-top: 1rem;
    }

    /* ===== AUTO-NEXT MODULE SECTION ===== */
    .auto-next {
      text-align: center;
      padding: 2rem;
      background: rgba(30,60,114,0.05);
      border-radius: var(--radius);
      margin-top: 2rem;
    }
    .countdown {
      font-size: 2rem;
      font-weight: bold;
      color: var(--secondary-color);
      margin: 1rem 0;
    }

    /* ===== VIDEO PROGRESS STYLES ===== */
    .video-progress-container {
      position: relative;
      width: 100%;
      height: 8px;
      background-color: rgba(255, 255, 255, 0.3);
      margin-top: 5px;
      border-radius: 4px;
      overflow: hidden;
    }

    .video-progress-bar {
      height: 100%;
      background-color: var(--accent-color);
      width: 0%;
      transition: width 0.3s ease;
    }

    .video-controls-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 10;
      transition: opacity 0.3s;
    }

    .video-controls-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .video-controls-overlay p {
      margin-bottom: 1rem;
      text-align: center;
      max-width: 80%;
    }

    /* ===== NEW IMPROVEMENTS ===== */
    .progress-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      position: relative;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .progress-step:not(:last-child):after {
      content: '';
      position: absolute;
      top: 15px;
      left: 50%;
      width: 100%;
      height: 2px;
      background-color: var(--border-color);
      z-index: 1;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--border-color);
      color: var(--text-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 0.5rem;
      z-index: 2;
      transition: var(--transition);
    }

    .step-active .step-number {
      background-color: var(--secondary-color);
      color: white;
    }

    .step-completed .step-number {
      background-color: var(--success-color);
      color: white;
    }

    .step-label {
      font-size: 0.8rem;
      text-align: center;
    }

    .quiz-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
    }

    .question-counter {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .video-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
    }

    .video-time {
      font-size: 0.9rem;
      color: white;
    }

    .video-controls button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification-success {
      background-color: var(--success-color);
      color: white;
    }

    .notification-error {
      background-color: var(--danger-color);
      color: white;
    }

    .notification-warning {
      background-color: var(--warning-color);
      color: white;
    }

    .hidden { display: none !important; }
    .mt-1 { margin-top: 1rem; }
    .mt-2 { margin-top: 2rem; }

    @media (max-width: 768px) {
      .topbar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }
      .brand { flex-direction: column; text-align: center; }
      .main-area { padding: 1rem; }
      .form-grid { grid-template-columns: 1fr; }
      .module-grid { grid-template-columns: 1fr; }
      .results-toolbar { flex-direction: column; }
      #resultsSearch { width: 100%; }
      .settings-grid { grid-template-columns: 1fr; }
      .certificate-footer {
        flex-direction: column;
        gap: 1rem;
      }
      .progress-indicator {
        flex-wrap: wrap;
      }
      .progress-step {
        min-width: 50%;
        margin-bottom: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="brand">
        <div class="brand-logo" id="brandLogo">I</div>
        <div class="brand-text">
          <h1>Industrial Induction LMS</h1>
          <p>New Joiner Training & HR Dashboard</p>
        </div>
      </div>
      <nav class="topnav">
        <button id="navNewJoiner" class="nav-btn nav-btn-active">New Joiner</button>
        <button id="navAdmin" class="nav-btn">Admin</button>
        <button id="themeToggle" class="theme-toggle" title="Toggle dark mode">
          <span id="themeIcon">üåô</span>
        </button>
      </nav>
    </header>

    <main class="main-area">
      <!-- Progress Indicator -->
      <div class="progress-indicator" id="progressIndicator">
        <div class="progress-step step-active" id="step1">
          <div class="step-number">1</div>
          <div class="step-label">Registration</div>
        </div>
        <div class="progress-step" id="step2">
          <div class="step-number">2</div>
          <div class="step-label">Acknowledgement</div>
        </div>
        <div class="progress-step" id="step3">
          <div class="step-number">3</div>
          <div class="step-label">Module Selection</div>
        </div>
        <div class="progress-step" id="step4">
          <div class="step-number">4</div>
          <div class="step-label">Training & Quiz</div>
        </div>
        <div class="progress-step" id="step5">
          <div class="step-number">5</div>
          <div class="step-label">Results</div>
        </div>
      </div>

      <!-- ================= NEW JOINER FLOW ================= -->

      <!-- Step 1: Registration -->
      <section id="nj-register" class="card">
        <h2>New Joiner Registration</h2>
        <p class="info">
          This training is mandatory for all new joiners. Please enter your details to begin.
        </p>
        <form id="registerForm" class="form-grid">
          <label>Full Name
            <input type="text" id="empName" required />
          </label>
          <label>Employee ID
            <input type="text" id="empID" required />
          </label>
          <label>Department
            <input type="text" id="empDept" required />
          </label>
          <label>Date of Joining
            <input type="date" id="empDOJ" required />
          </label>
          <button type="submit" class="btn-primary form-full-width">Continue</button>
        </form>
      </section>

      <!-- Step 2: Acknowledgement -->
      <section id="nj-ack" class="card hidden">
        <h2>Safety Acknowledgement</h2>
        <p class="info">
          Please confirm you understand and agree to the safety responsibilities.
        </p>
        <label class="checkbox-row">
          <input type="checkbox" id="ackChk1" />
          <span>I confirm that my personal details are correct.</span>
        </label>
        <label class="checkbox-row">
          <input type="checkbox" id="ackChk2" />
          <span>I agree to follow all safety rules explained in this training.</span>
        </label>
        <label class="checkbox-row">
          <input type="checkbox" id="ackChk3" />
          <span>I understand the importance of PPE (Personal Protective Equipment).</span>
        </label>
        <button id="btnStartModules" class="btn-primary btn-disabled" disabled>
          Continue to Modules
        </button>
      </section>

      <!-- Step 3: Module selection -->
      <section id="nj-module-select" class="card hidden">
        <div class="card-header-inline">
          <h2>Select Training Module</h2>
          <span id="njProfileSummary" class="badge">New Joiner</span>
        </div>
        <p class="info">Choose the module assigned to you by HR / Supervisor.</p>
        <div id="moduleList" class="module-grid"></div>
      </section>

      <!-- Step 4: Video + Quiz -->
      <section id="nj-training" class="card hidden">
        <div class="card-header-inline">
          <div style="display:flex; align-items:center; gap:10px;">
            <button id="btnBackToModules" class="btn-secondary btn-small">‚Üê Back</button>
            <h2 id="trainingModuleTitle">Module</h2>
          </div>
          <span id="trainingModuleInfo" class="badge badge-soft"></span>
        </div>

        <h3 class="section-title">Step 1: Watch the video</h3>
        <div class="video-wrapper">
          <div class="video-controls-overlay" id="videoControlsOverlay">
            <p>Please watch the video in its entirety. Skipping ahead is not allowed.</p>
            <button class="btn-primary" id="btnStartVideo">Start Video</button>
          </div>
          <video id="trainingVideo" playsinline>
            <source id="trainingVideoSource" src="" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
          <div class="video-controls">
            <button id="btnPlayPause">‚èØÔ∏è</button>
            <div class="video-time" id="videoTime">0:00 / 0:00</div>
          </div>
          <div class="video-progress-container">
            <div class="video-progress-bar" id="videoProgressBar"></div>
          </div>
        </div>
        <p id="videoStatus" class="info">
          ‚ñ∂ Please watch the full video. Skipping / rewinding is disabled until completion.
        </p>

        <h3 class="section-title">Step 2: Quiz</h3>
        <div class="quiz-timer">
          <span>‚è±Ô∏è Time Remaining:</span>
          <span id="quizTimer">--:--</span>
        </div>
        <p class="info">
          Answer all questions based on the video. Pass mark is <span id="passMarkLabel"></span>%.
        </p>
        <div class="question-counter" id="questionCounter">Question 1 of 2</div>
        <form id="quizForm">
          <div id="quizQuestions" class="quiz-list"></div>
          <div class="quiz-navigation">
            <button type="button" id="btnPrevQuestion" class="btn-secondary">Previous</button>
            <button type="button" id="btnNextQuestion" class="btn-primary">Next</button>
          </div>
          <button type="submit" class="btn-primary form-full-width mt-1" id="btnSubmitQuiz">Submit Quiz</button>
        </form>
        <p id="quizResult" class="quiz-result"></p>
      </section>

      <!-- Step 5: Result + Certificate -->
      <section id="nj-result" class="card hidden">
        <div class="card-header-inline">
          <h2>Training Result & Certificate</h2>
        </div>
        <div id="resultBox"></div>
        <div class="result-actions">
          <button id="btnPrintCertificate" class="btn-secondary hidden">
            Print / Save Certificate
          </button>
          <button id="btnNextModule" class="btn-primary hidden">
            Next Module
          </button>
        </div>
      </section>

      <!-- Auto Next Module Countdown -->
      <section id="autoNextModuleSection" class="card hidden">
        <div class="auto-next">
          <h2>Next Module Starting Soon</h2>
          <p>You've successfully completed the current module. The next module will start automatically.</p>
          <div class="countdown" id="countdownTimer">10</div>
          <button id="btnStartNow" class="btn-primary">Start Next Module Now</button>
        </div>
      </section>

      <!-- ================= ADMIN AREA ================= -->

      <!-- Admin login -->
      <section id="admin-login" class="card hidden">
        <h2>Admin Login</h2>
        <p class="info">Only HR / Training Admin is allowed to access this dashboard.</p>
        <form id="adminLoginForm" class="form-grid">
          <label>Username
            <input type="text" id="adminUser" required />
          </label>
          <label>Password
            <input type="password" id="adminPass" required />
          </label>
          <button type="submit" class="btn-primary form-full-width">Login</button>
        </form>
        <p class="info small">
          Default: <strong>admin / admin123</strong>
        </p>
        <p id="adminLoginError" class="error"></p>
      </section>

      <!-- Admin dashboard -->
      <section id="admin-dashboard" class="card hidden">
        <div class="card-header-inline">
          <h2>Admin Dashboard</h2>
          <div>
            <span id="adminWelcome" class="badge badge-soft">Admin</span>
            <button id="btnAdminLogout" class="btn-secondary btn-small">Logout</button>
          </div>
        </div>

        <div class="admin-tabs">
          <button class="admin-tab admin-tab-active" data-tab="overview">Overview</button>
          <button class="admin-tab" data-tab="results">Results</button>
          <button class="admin-tab" data-tab="modules">Modules</button>
          <button class="admin-tab" data-tab="admins">Admins</button>
          <button class="admin-tab" data-tab="settings">Settings</button>
        </div>

        <!-- Overview tab -->
        <div id="admin-tab-overview" class="admin-tab-panel">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Users Completed</div>
              <div id="statTotalUsers" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Pass Count</div>
              <div id="statPassCount" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Fail Count</div>
              <div id="statFailCount" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Active Modules</div>
              <div id="statModules" class="stat-value">0</div>
            </div>
          </div>

          <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
              <h3 class="section-title">Pass vs Fail Rate</h3>
              <canvas id="passFailChart" height="250"></canvas>
            </div>
            <div>
              <h3 class="section-title">Module Usage</h3>
              <canvas id="moduleUsageChart" height="250"></canvas>
            </div>
          </div>
        </div>

        <!-- Results tab -->
        <div id="admin-tab-results" class="admin-tab-panel hidden">
          <div class="results-toolbar">
            <input type="text" id="resultsSearch" placeholder="Search by name, ID, module..." />
            <button id="btnExportExcel" class="btn-secondary btn-small">
              Export All to Excel
            </button>
          </div>
          <div class="table-wrapper">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Date/Time</th>
                  <th>Name</th>
                  <th>Emp ID</th>
                  <th>Dept</th>
                  <th>Module</th>
                  <th>Score</th>
                  <th>Pass</th>
                  <th>Cert ID</th>
                </tr>
              </thead>
              <tbody id="resultsTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Modules tab -->
        <div id="admin-tab-modules" class="admin-tab-panel hidden">
          <h3 class="section-title">Existing Modules</h3>
          <div id="adminModuleList" class="module-grid small"></div>

          <h3 class="section-title">Add / Edit Module</h3>
          <form id="addModuleForm" class="form-grid">
            <label>Module Title
              <input type="text" id="modTitle" required />
            </label>
            <label>Category
              <input type="text" id="modCategory" placeholder="Safety / HR / Policy..." required />
            </label>
            <!-- Video path -->
            <label>Video Path (MP4)
              <input type="text" id="modVideoPath" placeholder="videos/safety-induction.mp4" required />
            </label>
            <label>Pass Mark (%)
              <input type="number" id="modPassMark" value="70" min="0" max="100" required />
            </label>
            <label>Quiz Time (seconds)
              <input type="number" id="modQuizTime" value="600" min="60" max="3600" required />
            </label>

            <div class="form-full-width">
              <h4>Quiz Questions</h4>
              <div id="questionsContainer"></div>
              <button type="button" id="addQuestionBtn" class="btn-secondary">Add Question</button>
            </div>

            <button type="submit" class="btn-primary form-full-width">Add Module</button>
          </form>
        </div>

        <!-- Admins tab -->
        <div id="admin-tab-admins" class="admin-tab-panel hidden">
          <h3 class="section-title">Admin Users</h3>
          <div class="table-wrapper">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Last Login</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adminsTableBody"></tbody>
            </table>
          </div>

          <h3 class="section-title mt-2">Add New Admin</h3>
          <form id="addAdminForm" class="form-grid">
            <label>Username
              <input type="text" id="newAdminUser" required />
            </label>
            <label>Password
              <input type="password" id="newAdminPass" required />
            </label>
            <label>Confirm Password
              <input type="password" id="newAdminPassConfirm" required />
            </label>
            <label>Role
              <select id="newAdminRole">
                <option value="admin">Admin</option>
                <option value="superadmin">Super Admin</option>
              </select>
            </label>
            <button type="submit" class="btn-primary form-full-width">Add Admin</button>
          </form>

          <h3 class="section-title mt-2">Change Password</h3>
          <form id="changePasswordForm" class="form-grid">
            <label>Current Password
              <input type="password" id="currentPassword" required />
            </label>
            <label>New Password
              <input type="password" id="newPassword" required />
            </label>
            <label>Confirm New Password
              <input type="password" id="confirmNewPassword" required />
            </label>
            <button type="submit" class="btn-primary form-full-width">Change Password</button>
          </form>
        </div>

        <!-- Settings tab -->
        <div id="admin-tab-settings" class="admin-tab-panel hidden">
          <div class="settings-grid">
            <div>
              <h3 class="section-title">Appearance</h3>
              <label>Theme Color</label>
              <div class="color-picker">
                <div class="color-option active" style="background-color: #1e3c72;" data-color="#1e3c72"></div>
                <div class="color-option" style="background-color: #2d8f5a;" data-color="#2d8f5a"></div>
                <div class="color-option" style="background-color: #d32f2f;" data-color="#d32f2f"></div>
                <div class="color-option" style="background-color: #e6a700;" data-color="#e6a700"></div>
                <div class="color-option" style="background-color: #6a1b9a;" data-color="#6a1b9a"></div>
              </div>
            </div>

            <div>
              <h3 class="section-title">System Settings</h3>
              <form id="systemSettingsForm" class="form-grid">
                <label>App Name
                  <input type="text" id="appName" value="Industrial Induction LMS" />
                </label>
                <label>App Description
                  <textarea id="appDescription" rows="3">New Joiner Training & HR Dashboard</textarea>
                </label>
                <label>Auto Next Module
                  <select id="autoNextModule">
                    <option value="enabled">Enabled</option>
                    <option value="disabled">Disabled</option>
                  </select>
                </label>
                <label>Default Quiz Time (seconds)
                  <input type="number" id="defaultQuizTime" value="600" min="60" max="3600" />
                </label>
                <label>Default Pass Mark (%)
                  <input type="number" id="defaultPassMark" value="70" min="0" max="100" />
                </label>
                <button type="submit" class="btn-primary form-full-width">Save Settings</button>
              </form>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Notification System -->
  <div id="notification" class="notification"></div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- App logic -->
  <script>
    // ================= GOOGLE SHEETS BACKEND CONFIG =================
    // üîß Replace this with your deployed Apps Script Web App URL
    const API_URL = "https://script.google.com/macros/s/AKfycbyVP0WUL1jVaLo6kFO3b43dbDtLinJlmxCKD6HA80DqGduR6di3pAd4b-5X09TDEXDz/exec";

    // Notification system
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification notification-${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    async function sheetPost(action, payload = {}) {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ action, payload })
        });
        const data = await res.json();
        if (data.status !== 'ok') {
          console.error('Sheet error:', data.message);
          throw new Error(data.message || 'Sheet error');
        }
        return data.data || null;
      } catch (err) {
        console.error('sheetPost failed:', err);
        showNotification('Connection error. Using offline mode.', 'warning');
        throw err;
      }
    }

    async function saveUserToSheet(user) {
      try { await sheetPost('addUser', user); } catch(e) {}
    }
    async function saveAttemptToSheet(attempt) {
      try { await sheetPost('addAttempt', attempt); } catch(e) {}
    }
    async function saveModuleToSheet(module) {
      try { await sheetPost('saveModule', module); } catch(e) {}
    }
    async function updateModuleInSheet(module) {
      try { await sheetPost('updateModule', module); } catch(e) {}
    }
    async function deleteModuleFromSheet(id) {
      try { await sheetPost('deleteModule', { id }); } catch(e) {}
    }

    const DEFAULT_MODULES = [
      {
        id: 'safety-induction',
        title: 'Safety Induction',
        category: 'Safety',
        video: 'videos/safety-induction.mp4',
        thumbnail: '',
        passMark: 70,
        quizTime: 600,
        questions: [
          {
            text: 'What is the first thing you should do in case of a fire?',
            options: ['Run to the exit', 'Activate the fire alarm', 'Try to put it out yourself', 'Hide under your desk'],
            correct: 1
          },
          {
            text: 'When should you wear Personal Protective Equipment (PPE)?',
            options: ['Only when supervisor is watching', 'Only in high-risk areas', 'At all times in designated areas', 'When you feel like it'],
            correct: 2
          }
        ]
      },
      {
        id: 'hr-policies',
        title: 'HR Policies & Procedures',
        category: 'HR',
        video: 'videos/hr-policies.mp4',
        thumbnail: '',
        passMark: 80,
        quizTime: 900,
        questions: [
          {
            text: 'How many days in advance should you apply for leave?',
            options: ['Same day', 'At least 3 days', 'At least 7 days', 'Whenever convenient'],
            correct: 2
          },
          {
            text: 'What should you do if you witness harassment at workplace?',
            options: ['Ignore it', 'Report to HR immediately', 'Confront the person directly', 'Discuss with colleagues'],
            correct: 1
          }
        ]
      }
    ];

    function mergeModules(defaults, loaded) {
      const map = {};
      defaults.forEach(m => map[m.id] = m);
      loaded.forEach(m => map[m.id] = m);
      return Object.values(map);
    }

    async function loadDataFromSheets() {
      try {
        const [usersData, attemptsData, modulesData] = await Promise.all([
          sheetPost('getUsers').catch(() => []),
          sheetPost('getAttempts').catch(() => []),
          sheetPost('getModules').catch(() => [])
        ]);

        // Users
        if (Array.isArray(usersData)) {
          APP_STATE.users = usersData.map(u => ({
            id: String(u.UserID || '').trim(),
            name: String(u.Name || '').trim(),
            department: String(u.Department || '').trim(),
            doj: u.DOJ ? String(u.DOJ) : ''
          })).filter(u => u.id);
        }

        // Attempts
        if (Array.isArray(attemptsData)) {
          APP_STATE.attempts = attemptsData.map(a => ({
            id: String(a.CertID || '').trim(),
            userId: String(a.UserID || '').trim(),
            userName: String(a.Name || '').trim(),
            userDept: String(a.Department || '').trim(),
            moduleId: String(a.ModuleID || '').trim(),
            moduleTitle: String(a.ModuleTitle || '').trim(),
            score: Number(a.Score || 0),
            passed: (a.Passed === true || a.Passed === 'TRUE' || a.Passed === 'PASS' || a.Passed === 'Yes'),
            timestamp: a.Timestamp ? String(a.Timestamp) : new Date().toISOString()
          })).filter(a => a.userId);
        }

        // Modules
        let loadedModules = [];
        if (Array.isArray(modulesData)) {
          loadedModules = modulesData.map(m => ({
            id: String(m.ModuleID || '').trim(),
            title: String(m.Title || '').trim(),
            category: String(m.Category || '').trim(),
            video: String(m.Video || '').trim(),
            thumbnail: '',
            passMark: Number(m.PassMark || 0),
            quizTime: Number(m.QuizTime || 0),
            questions: m.Questions ? JSON.parse(m.Questions) : []
          })).filter(m => m.id);
        }

        APP_STATE.modules = mergeModules(DEFAULT_MODULES, loadedModules);
      } catch (e) {
        console.error('Error loading data from Sheets:', e);
        APP_STATE.modules = DEFAULT_MODULES.slice();
      }
    }

    // ===== APP STATE AND DATA =====
    const APP_STATE = {
      currentUser: null,
      currentModule: null,
      currentAttempt: null,
      currentAdmin: null,
      adminLoggedIn: false,
      videoFinished: false,
      maxWatched: 0,
      modules: DEFAULT_MODULES.slice(),
      attempts: [],
      users: [],
      admins: JSON.parse(localStorage.getItem('lms_admins')) || [
        { username: 'admin', password: 'admin123', role: 'superadmin', lastLogin: null },
        { username: 'hr', password: 'hr123', role: 'admin', lastLogin: null }
      ],
      settings: JSON.parse(localStorage.getItem('lms_settings')) || {
        appName: 'Industrial Induction LMS',
        appDescription: 'New Joiner Training & HR Dashboard',
        themeColor: '#1e3c72',
        autoNextModule: 'enabled',
        defaultQuizTime: 600,
        defaultPassMark: 70
      },
      quizTimer: null,
      quizTimeRemaining: 0,
      autoNextTimer: null,
      autoNextCountdown: 10,
      charts: {
        passFailChart: null,
        moduleUsageChart: null
      },
      currentQuestionIndex: 0
    };

    // ===== THEME MANAGEMENT =====
    function initTheme() {
      const savedTheme = localStorage.getItem('lms_theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('lms_theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      document.getElementById('themeIcon').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    // ===== DOM ELEMENTS =====
    const navNewJoiner = document.getElementById('navNewJoiner');
    const navAdmin = document.getElementById('navAdmin');
    const themeToggle = document.getElementById('themeToggle');

    const progressIndicator = document.getElementById('progressIndicator');
    const steps = document.querySelectorAll('.progress-step');

    const njRegister = document.getElementById('nj-register');
    const njAck = document.getElementById('nj-ack');
    const njModuleSelect = document.getElementById('nj-module-select');
    const njTraining = document.getElementById('nj-training');
    const njResult = document.getElementById('nj-result');
    const autoNextModuleSection = document.getElementById('autoNextModuleSection');

    const adminLogin = document.getElementById('admin-login');
    const adminDashboard = document.getElementById('admin-dashboard');

    const registerForm = document.getElementById('registerForm');
    const empName = document.getElementById('empName');
    const empID = document.getElementById('empID');
    const empDept = document.getElementById('empDept');
    const empDOJ = document.getElementById('empDOJ');

    const ackChk1 = document.getElementById('ackChk1');
    const ackChk2 = document.getElementById('ackChk2');
    const ackChk3 = document.getElementById('ackChk3');
    const btnStartModules = document.getElementById('btnStartModules');

    const moduleList = document.getElementById('moduleList');
    const njProfileSummary = document.getElementById('njProfileSummary');

    const trainingModuleTitle = document.getElementById('trainingModuleTitle');
    const trainingModuleInfo = document.getElementById('trainingModuleInfo');
    const trainingVideo = document.getElementById('trainingVideo');
    const trainingVideoSource = document.getElementById('trainingVideoSource');
    const videoStatus = document.getElementById('videoStatus');
    const passMarkLabel = document.getElementById('passMarkLabel');
    const quizForm = document.getElementById('quizForm');
    const quizQuestions = document.getElementById('quizQuestions');
    const quizResult = document.getElementById('quizResult');
    const quizTimer = document.getElementById('quizTimer');
    const questionCounter = document.getElementById('questionCounter');
    const btnPrevQuestion = document.getElementById('btnPrevQuestion');
    const btnNextQuestion = document.getElementById('btnNextQuestion');
    const btnSubmitQuiz = document.getElementById('btnSubmitQuiz');
    const btnPlayPause = document.getElementById('btnPlayPause');
    const videoTime = document.getElementById('videoTime');

    const resultBox = document.getElementById('resultBox');
    const btnPrintCertificate = document.getElementById('btnPrintCertificate');
    const btnNextModule = document.getElementById('btnNextModule');

    const countdownTimer = document.getElementById('countdownTimer');
    const btnStartNow = document.getElementById('btnStartNow');

    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminUser = document.getElementById('adminUser');
    const adminPass = document.getElementById('adminPass');
    const adminLoginError = document.getElementById('adminLoginError');
    const adminWelcome = document.getElementById('adminWelcome');

    const btnAdminLogout = document.getElementById('btnAdminLogout');
    const adminTabs = document.querySelectorAll('.admin-tab');
    const adminTabPanels = document.querySelectorAll('.admin-tab-panel');

    const statTotalUsers = document.getElementById('statTotalUsers');
    const statPassCount = document.getElementById('statPassCount');
    const statFailCount = document.getElementById('statFailCount');
    const statModules = document.getElementById('statModules');
    const passFailChartCanvas = document.getElementById('passFailChart');
    const moduleUsageChartCanvas = document.getElementById('moduleUsageChart');

    const resultsSearch = document.getElementById('resultsSearch');
    const btnExportExcel = document.getElementById('btnExportExcel');
    const resultsTableBody = document.getElementById('resultsTableBody');

    const adminModuleList = document.getElementById('adminModuleList');
    const addModuleForm = document.getElementById('addModuleForm');
    const questionsContainer = document.getElementById('questionsContainer');
    const addQuestionBtn = document.getElementById('addQuestionBtn');

    const colorOptions = document.querySelectorAll('.color-option');
    const systemSettingsForm = document.getElementById('systemSettingsForm');

    const addAdminForm = document.getElementById('addAdminForm');
    const changePasswordForm = document.getElementById('changePasswordForm');

    const btnBackToModules = document.getElementById('btnBackToModules');

    const videoControlsOverlay = document.getElementById('videoControlsOverlay');
    const btnStartVideo = document.getElementById('btnStartVideo');
    const videoProgressBar = document.getElementById('videoProgressBar');

    document.addEventListener('DOMContentLoaded', () => { initApp(); });

    navNewJoiner.addEventListener('click', () => switchView('newJoiner'));
    navAdmin.addEventListener('click', () => switchView('admin'));
    themeToggle.addEventListener('click', toggleTheme);

    registerForm.addEventListener('submit', handleRegistration);
    [ackChk1, ackChk2, ackChk3].forEach(cb => cb.addEventListener('change', updateAckButton));
    btnStartModules.addEventListener('click', showModuleSelection);

    btnStartVideo.addEventListener('click', startVideoPlayback);
    trainingVideo.addEventListener('timeupdate', checkVideoProgress);
    trainingVideo.addEventListener('ended', handleVideoEnded);
    btnPlayPause.addEventListener('click', toggleVideoPlayback);

    trainingVideo.addEventListener('seeking', function (e) {
      if (!APP_STATE.videoFinished) {
        trainingVideo.currentTime = APP_STATE.maxWatched || 0;
        if (trainingVideo.paused) {
          trainingVideo.play().catch(() => {});
        }
      }
    });

    trainingVideo.addEventListener('mousedown', function (e) {
      if (!APP_STATE.videoFinished) {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      }
    });

    trainingVideo.addEventListener('click', function (e) {
      if (!APP_STATE.videoFinished) {
        e.preventDefault();
        e.stopImmediatePropagation();
      }
    });

    document.addEventListener('keydown', function (e) {
      if (!APP_STATE.videoFinished &&
          (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
        e.preventDefault();
      }
    });

    quizForm.addEventListener('submit', handleQuizSubmit);
    btnPrevQuestion.addEventListener('click', goToPreviousQuestion);
    btnNextQuestion.addEventListener('click', goToNextQuestion);

    btnPrintCertificate.addEventListener('click', generateCertificate);
    btnNextModule.addEventListener('click', showNextModule);
    btnStartNow.addEventListener('click', startNextModuleNow);

    adminLoginForm.addEventListener('submit', handleAdminLogin);
    btnAdminLogout.addEventListener('click', handleAdminLogoutClick);

    adminTabs.forEach(tab => tab.addEventListener('click', () => switchAdminTab(tab.dataset.tab)));

    resultsSearch.addEventListener('input', filterResultsTable);
    btnExportExcel.addEventListener('click', exportToExcel);

    addModuleForm.addEventListener('submit', handleAddModule);
    addQuestionBtn.addEventListener('click', addQuestionSet);

    colorOptions.forEach(option => option.addEventListener('click', handleColorChange));
    systemSettingsForm.addEventListener('submit', handleSystemSettings);

    addAdminForm.addEventListener('submit', handleAddAdmin);
    changePasswordForm.addEventListener('submit', handlePasswordChange);

    btnBackToModules.addEventListener('click', handleBackToModules);

    const modTitleInput = document.getElementById('modTitle');
    const modVideoPathInput = document.getElementById('modVideoPath');
    modTitleInput.addEventListener('blur', () => {
      const title = modTitleInput.value.trim();
      if (title && !modVideoPathInput.value.trim()) {
        const slug = title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        modVideoPathInput.value = `videos/${slug}.mp4`;
      }
    });

    async function initApp() {
      initTheme();
      loadSettings();

      const today = new Date().toISOString().split('T')[0];
      empDOJ.value = today;

      await loadDataFromSheets();

      checkReturningUser();
      renderModuleList();

      if (localStorage.getItem('lms_admin_logged_in') === 'true') {
        APP_STATE.adminLoggedIn = true;
        const adminUsername = localStorage.getItem('lms_current_admin');
        const admin = APP_STATE.admins.find(a => a.username === adminUsername);
        if (admin) {
          APP_STATE.currentAdmin = admin;
          showAdminDashboard();
        }
      }

      initCharts();
      addQuestionSet();
    }

    function loadSettings() {
      document.documentElement.style.setProperty('--primary-color', APP_STATE.settings.themeColor);
      document.documentElement.style.setProperty('--secondary-color', APP_STATE.settings.themeColor);

      document.title = APP_STATE.settings.appName;
      document.querySelector('.brand-text h1').textContent = APP_STATE.settings.appName;
      document.querySelector('.brand-text p').textContent = APP_STATE.settings.appDescription;

      document.getElementById('appName').value = APP_STATE.settings.appName;
      document.getElementById('appDescription').value = APP_STATE.settings.appDescription;
      document.getElementById('autoNextModule').value = APP_STATE.settings.autoNextModule;
      document.getElementById('defaultQuizTime').value = APP_STATE.settings.defaultQuizTime;
      document.getElementById('defaultPassMark').value = APP_STATE.settings.defaultPassMark;
    }

    function initCharts() {
      if (passFailChartCanvas) {
        APP_STATE.charts.passFailChart = new Chart(passFailChartCanvas, {
          type: 'pie',
          data: {
            labels: ['Pass', 'Fail'],
            datasets: [{
              data: [0, 0],
              backgroundColor: [APP_STATE.settings.themeColor, '#d32f2f'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: 'Pass vs Fail Rate' }
            }
          }
        });
      }

      if (moduleUsageChartCanvas) {
        APP_STATE.charts.moduleUsageChart = new Chart(moduleUsageChartCanvas, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: 'Completion Count',
              data: [],
              backgroundColor: APP_STATE.settings.themeColor,
              borderColor: APP_STATE.settings.themeColor,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: {
              title: { display: true, text: 'Module Usage' },
              legend: { display: false }
            }
          }
        });
      }

      updateCharts();
    }

    function updateCharts() {
      if (APP_STATE.charts.passFailChart) {
        const passCount = APP_STATE.attempts.filter(a => a.passed).length;
        const failCount = APP_STATE.attempts.filter(a => !a.passed).length;

        APP_STATE.charts.passFailChart.data.datasets[0].data = [passCount, failCount];
        APP_STATE.charts.passFailChart.update();
      }

      if (APP_STATE.charts.moduleUsageChart) {
        const moduleCounts = {};
        APP_STATE.attempts.forEach(a => {
          moduleCounts[a.moduleTitle] = (moduleCounts[a.moduleTitle] || 0) + 1;
        });

        const sortedModules = Object.entries(moduleCounts)
          .sort((a, b) => b[1] - a[1])
          .reduce((obj, [key, value]) => {
            obj[key] = value;
            return obj;
          }, {});

        APP_STATE.charts.moduleUsageChart.data.labels = Object.keys(sortedModules);
        APP_STATE.charts.moduleUsageChart.data.datasets[0].data = Object.values(sortedModules);
        APP_STATE.charts.moduleUsageChart.update();
      }
    }

    function checkReturningUser() {
      const lastUserId = localStorage.getItem('lms_last_user_id');
      if (!lastUserId) return;

      const user = APP_STATE.users.find(u => u.id === lastUserId);
      if (!user) return;

      empName.value = user.name;
      empID.value = user.id;
      empDept.value = user.department;
      empDOJ.value = user.doj;

      const infoElement = njRegister.querySelector('.info');
      infoElement.innerHTML += `<p style="margin-top: 10px; color: var(--success-color); font-weight: 500;">Welcome back, ${user.name}! Your details have been pre-filled.</p>`;
    }

    function addQuestionSet() {
      const questionIndex = questionsContainer.children.length;
      const qs = document.createElement('div');
      qs.className = 'question-set';
      qs.innerHTML = `
        <div class="question-set-header">
          <div class="question-set-title">Question ${questionIndex + 1}</div>
          <button type="button" class="btn-remove">Remove</button>
        </div>
        <label>Question Text
          <input type="text" class="question-text" placeholder="Enter the question" required />
        </label>
        <label>Correct Answer
          <input type="text" class="question-correct" placeholder="Enter the correct answer" required />
        </label>
        <label>Other Options (comma separated)
          <input type="text" class="question-others" placeholder="Wrong answer 1, Wrong answer 2, Wrong answer 3" required />
        </label>
      `;
      qs.querySelector('.btn-remove').addEventListener('click', () => {
        if (questionsContainer.children.length > 1) {
          questionsContainer.removeChild(qs);
          updateQuestionNumbers();
        } else {
          showNotification('You need at least one question for the module.', 'warning');
        }
      });
      questionsContainer.appendChild(qs);
    }

    function updateQuestionNumbers() {
      [...questionsContainer.querySelectorAll('.question-set')].forEach((set, idx) => {
        set.querySelector('.question-set-title').textContent = `Question ${idx + 1}`;
      });
    }

    function switchView(view) {
      if (view === 'newJoiner') {
        navNewJoiner.classList.add('nav-btn-active');
        navAdmin.classList.remove('nav-btn-active');
        showSection(njRegister);
        [njAck, njModuleSelect, njTraining, njResult, autoNextModuleSection, adminLogin, adminDashboard].forEach(hideSection);
        updateProgressIndicator(1);
      } else {
        navNewJoiner.classList.remove('nav-btn-active');
        navAdmin.classList.add('nav-btn-active');
        [njRegister, njAck, njModuleSelect, njTraining, njResult, autoNextModuleSection].forEach(hideSection);
        if (APP_STATE.adminLoggedIn) showAdminDashboard();
        else showSection(adminLogin);
      }
    }

    function updateProgressIndicator(step) {
      steps.forEach((stepEl, index) => {
        if (index < step - 1) {
          stepEl.classList.add('step-completed');
          stepEl.classList.remove('step-active');
        } else if (index === step - 1) {
          stepEl.classList.add('step-active');
          stepEl.classList.remove('step-completed');
        } else {
          stepEl.classList.remove('step-active', 'step-completed');
        }
      });
    }

    function showSection(el){ el.classList.remove('hidden'); }
    function hideSection(el){ el.classList.add('hidden'); }

    async function handleRegistration(e) {
      e.preventDefault();
      const existing = APP_STATE.users.find(u => u.id === empID.value.trim());

      if (existing) {
        APP_STATE.currentUser = existing;
        njProfileSummary.textContent = `${existing.name} (${existing.department})`;
        njRegister.classList.add('hidden');
        njModuleSelect.classList.remove('hidden');
        const infoElement = njModuleSelect.querySelector('.info');
        infoElement.innerHTML = `Welcome back, ${existing.name}! Please select your training module.`;
        updateProgressIndicator(3);
      } else {
        APP_STATE.currentUser = {
          name: empName.value.trim(),
          id: empID.value.trim(),
          department: empDept.value.trim(),
          doj: empDOJ.value
        };
        APP_STATE.users.push(APP_STATE.currentUser);
        localStorage.setItem('lms_last_user_id', APP_STATE.currentUser.id);

        // Save to Google Sheet
        await saveUserToSheet(APP_STATE.currentUser);

        njProfileSummary.textContent = `${APP_STATE.currentUser.name} (${APP_STATE.currentUser.department})`;
        njRegister.classList.add('hidden');
        njAck.classList.remove('hidden');
        updateProgressIndicator(2);
      }
    }

    function updateAckButton() {
      const ok = ackChk1.checked && ackChk2.checked && ackChk3.checked;
      btnStartModules.disabled = !ok;
      btnStartModules.classList.toggle('btn-disabled', !ok);
    }

    function showModuleSelection() {
      njAck.classList.add('hidden');
      njModuleSelect.classList.remove('hidden');
      updateProgressIndicator(3);
    }

    function renderModuleList() {
      moduleList.innerHTML = '';
      adminModuleList.innerHTML = '';

      APP_STATE.modules.forEach(mod => {
        const card = document.createElement('div');
        card.className = 'module-card';
        card.innerHTML = `
          <div class="module-thumbnail">${mod.title.charAt(0)}</div>
          <h3>${mod.title}</h3>
          <p>${mod.category}</p>
          <div class="module-meta">
            <span>Pass Mark: ${mod.passMark}%</span>
            <span>Time: ${Math.floor(mod.quizTime / 60)}:${(mod.quizTime % 60).toString().padStart(2, '0')}</span>
          </div>
        `;
        card.addEventListener('click', () => startModule(mod));
        moduleList.appendChild(card);

        const adminCard = document.createElement('div');
        adminCard.className = 'module-card';
        adminCard.innerHTML = `
          <div class="module-thumbnail">${mod.title.charAt(0)}</div>
          <h3>${mod.title}</h3>
          <p>${mod.category}</p>
          <div class="module-meta">
            <span>Pass: ${mod.passMark}%</span>
            <span>ID: ${mod.id}</span>
          </div>
          <div class="module-actions mt-1">
            <button class="btn-secondary btn-small" onclick="editModule('${mod.id}')">Edit</button>
            <button class="btn-remove btn-small" onclick="deleteModule('${mod.id}')">Delete</button>
          </div>
        `;
        adminModuleList.appendChild(adminCard);
      });

      updateAdminStats();
    }

    function startModule(module) {
      APP_STATE.currentModule = module;
      APP_STATE.videoFinished = false;
      APP_STATE.maxWatched = 0;
      APP_STATE.currentQuestionIndex = 0;

      trainingModuleTitle.textContent = module.title;
      trainingModuleInfo.textContent = module.category;
      passMarkLabel.textContent = module.passMark;

      trainingVideoSource.src = module.video;
      trainingVideo.load();
      trainingVideo.currentTime = 0;

      videoStatus.textContent = '‚ñ∂ Please watch the full video. Skipping / rewinding is disabled until completion.';
      videoStatus.className = 'info';

      renderQuizQuestions(module.questions);
      quizResult.textContent = '';
      quizResult.className = 'quiz-result';
      quizForm.reset();

      APP_STATE.quizTimeRemaining = module.quizTime;
      quizTimer.textContent = '--:--';
      if (APP_STATE.quizTimer) clearInterval(APP_STATE.quizTimer);

      videoControlsOverlay.classList.remove('hidden');

      njModuleSelect.classList.add('hidden');
      njResult.classList.add('hidden');
      njTraining.classList.remove('hidden');
      autoNextModuleSection.classList.add('hidden');
      
      updateProgressIndicator(4);
      updateQuestionNavigation();
    }

    function toggleVideoPlayback() {
      if (trainingVideo.paused) {
        trainingVideo.play();
        btnPlayPause.textContent = '‚è∏Ô∏è';
      } else {
        trainingVideo.pause();
        btnPlayPause.textContent = '‚èØÔ∏è';
      }
    }

    function startVideoPlayback() {
      videoControlsOverlay.classList.add('hidden');
      trainingVideo.play().catch(e => {
        console.error('Error playing video:', e);
        videoControlsOverlay.classList.remove('hidden');
        showNotification('Error playing video. Please check if the video file exists.', 'error');
      });
      btnPlayPause.textContent = '‚è∏Ô∏è';
    }

    function updateQuizTimer() {
      if (APP_STATE.quizTimeRemaining <= 0) {
        clearInterval(APP_STATE.quizTimer);
        handleQuizTimeout();
        return;
      }
      const m = Math.floor(APP_STATE.quizTimeRemaining / 60);
      const s = APP_STATE.quizTimeRemaining % 60;
      quizTimer.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      APP_STATE.quizTimeRemaining--;
    }

    function handleQuizTimeout() {
      showNotification('Time is up! Submitting your quiz automatically.', 'warning');
      quizForm.dispatchEvent(new Event('submit'));
    }

    function checkVideoProgress() {
      if (!trainingVideo.duration) return;

      const progress = (trainingVideo.currentTime / trainingVideo.duration) * 100;
      videoProgressBar.style.width = `${progress}%`;

      // Update video time display
      const currentTime = formatTime(trainingVideo.currentTime);
      const duration = formatTime(trainingVideo.duration);
      videoTime.textContent = `${currentTime} / ${duration}`;

      if (!APP_STATE.videoFinished && trainingVideo.currentTime > APP_STATE.maxWatched) {
        APP_STATE.maxWatched = trainingVideo.currentTime;
      }

      if (!APP_STATE.videoFinished &&
          Math.abs(trainingVideo.currentTime - APP_STATE.maxWatched) > 0.5) {
        const safeTime = APP_STATE.maxWatched || 0;
        trainingVideo.currentTime = safeTime;

        if (trainingVideo.paused) {
          trainingVideo.play().catch(() => {});
        }
      }
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function handleVideoEnded() {
      APP_STATE.videoFinished = true;
      videoStatus.textContent = '‚úì Video completed. Quiz unlocked.';
      videoStatus.className = 'info';

      APP_STATE.quizTimeRemaining = APP_STATE.currentModule.quizTime;
      quizTimer.textContent = '--:--';
      if (APP_STATE.quizTimer) clearInterval(APP_STATE.quizTimer);
      APP_STATE.quizTimer = setInterval(updateQuizTimer, 1000);
      btnPlayPause.textContent = '‚èØÔ∏è';
    }

    function renderQuizQuestions(questions) {
      quizQuestions.innerHTML = '';
      questions.forEach((q, idx) => {
        const qDiv = document.createElement('div');
        qDiv.className = 'quiz-question';
        qDiv.id = `question-${idx}`;
        qDiv.style.display = idx === 0 ? 'block' : 'none';
        let optsHtml = '';
        q.options.forEach((opt, j) => {
          optsHtml += `
            <div class="quiz-option">
              <input type="radio" id="q${idx}o${j}" name="q${idx}" value="${j}">
              <label for="q${idx}o${j}">${opt}</label>
            </div>
          `;
        });
        qDiv.innerHTML = `
          <h4>Question ${idx + 1}: ${q.text}</h4>
          <div class="quiz-options">${optsHtml}</div>
        `;
        quizQuestions.appendChild(qDiv);
      });
      updateQuestionCounter();
    }

    function goToPreviousQuestion() {
      if (APP_STATE.currentQuestionIndex > 0) {
        APP_STATE.currentQuestionIndex--;
        updateQuestionNavigation();
      }
    }

    function goToNextQuestion() {
      if (APP_STATE.currentQuestionIndex < APP_STATE.currentModule.questions.length - 1) {
        APP_STATE.currentQuestionIndex++;
        updateQuestionNavigation();
      }
    }

    function updateQuestionNavigation() {
      // Hide all questions
      const questions = document.querySelectorAll('.quiz-question');
      questions.forEach(q => q.style.display = 'none');
      
      // Show current question
      const currentQuestion = document.getElementById(`question-${APP_STATE.currentQuestionIndex}`);
      if (currentQuestion) {
        currentQuestion.style.display = 'block';
      }
      
      // Update question counter
      updateQuestionCounter();
      
      // Update button states
      btnPrevQuestion.disabled = APP_STATE.currentQuestionIndex === 0;
      btnNextQuestion.disabled = APP_STATE.currentQuestionIndex === APP_STATE.currentModule.questions.length - 1;
      btnSubmitQuiz.style.display = APP_STATE.currentQuestionIndex === APP_STATE.currentModule.questions.length - 1 ? 'block' : 'none';
    }

    function updateQuestionCounter() {
      questionCounter.textContent = `Question ${APP_STATE.currentQuestionIndex + 1} of ${APP_STATE.currentModule.questions.length}`;
    }

    async function handleQuizSubmit(e) {
      e.preventDefault();
      if (!APP_STATE.videoFinished) {
        showNotification('You must watch the full video before attempting the quiz.', 'warning');
        return;
      }
      clearInterval(APP_STATE.quizTimer);

      const formData = new FormData(quizForm);
      let score = 0;
      const total = APP_STATE.currentModule.questions.length;

      APP_STATE.currentModule.questions.forEach((q, i) => {
        const sel = parseInt(formData.get(`q${i}`), 10);
        if (sel === q.correct) score++;
      });

      const percentage = Math.round((score / total) * 100);
      const passed = percentage >= APP_STATE.currentModule.passMark;

      const attempt = {
        id: generateCertId(),
        userId: APP_STATE.currentUser.id,
        userName: APP_STATE.currentUser.name,
        userDept: APP_STATE.currentUser.department,
        moduleId: APP_STATE.currentModule.id,
        moduleTitle: APP_STATE.currentModule.title,
        score: percentage,
        passed,
        timestamp: new Date().toISOString()
      };

      APP_STATE.attempts.push(attempt);

      // Save to Google Sheet
      await saveAttemptToSheet(attempt);

      APP_STATE.currentAttempt = attempt;

      showResult(percentage, passed, attempt.id);
    }

    function showResult(score, passed, certId) {
      if (passed) {
        resultBox.innerHTML = `
          <div class="result-pass">
            <div class="result-icon">‚úì</div>
            <h3>Congratulations!</h3>
            <div class="result-score">${score}%</div>
            <p>You have successfully passed the ${APP_STATE.currentModule.title} training.</p>
            <p>Certificate ID: <strong>${certId}</strong></p>
          </div>
        `;
        resultBox.className = 'result-pass';
        btnPrintCertificate.classList.remove('hidden');

        const idx = APP_STATE.modules.findIndex(m => m.id === APP_STATE.currentModule.id);
        if (APP_STATE.settings.autoNextModule === 'enabled' && idx < APP_STATE.modules.length - 1) {
          btnNextModule.classList.remove('hidden');
          startAutoNextCountdown();
        } else {
          btnNextModule.classList.add('hidden');
        }
      } else {
        resultBox.innerHTML = `
          <div class="result-fail">
            <div class="result-icon">‚úó</div>
            <h3>Training Not Completed</h3>
            <div class="result-score">${score}%</div>
            <p>You must re-watch the full video before reattempting the quiz.</p>
          </div>
        `;
        resultBox.className = 'result-fail';
        btnPrintCertificate.classList.add('hidden');
        btnNextModule.classList.add('hidden');

        APP_STATE.videoFinished = false;
        APP_STATE.maxWatched = 0;

        setTimeout(() => {
          njResult.classList.add('hidden');
          startModule(APP_STATE.currentModule);
        }, 2000);
      }

      njTraining.classList.add('hidden');
      njResult.classList.remove('hidden');
      updateProgressIndicator(5);
      updateAdminStats();
      renderResultsTable();
      updateCharts();
    }

    function startAutoNextCountdown() {
      APP_STATE.autoNextCountdown = 10;
      countdownTimer.textContent = APP_STATE.autoNextCountdown;
      autoNextModuleSection.classList.remove('hidden');

      if (APP_STATE.autoNextTimer) clearInterval(APP_STATE.autoNextTimer);
      APP_STATE.autoNextTimer = setInterval(() => {
        APP_STATE.autoNextCountdown--;
        countdownTimer.textContent = APP_STATE.autoNextCountdown;
        if (APP_STATE.autoNextCountdown <= 0) {
          clearInterval(APP_STATE.autoNextTimer);
          startNextModuleNow();
        }
      }, 1000);
    }

    function startNextModuleNow() {
      if (APP_STATE.autoNextTimer) clearInterval(APP_STATE.autoNextTimer);
      autoNextModuleSection.classList.add('hidden');
      showNextModule();
    }

    function showNextModule() {
      const idx = APP_STATE.modules.findIndex(m => m.id === APP_STATE.currentModule.id);
      if (idx < APP_STATE.modules.length - 1) {
        startModule(APP_STATE.modules[idx + 1]);
        njResult.classList.add('hidden');
      } else {
        showNotification('Congratulations! You have completed all available training modules.', 'success');
      }
    }

    function generateCertId() {
      return 'CERT-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2,5).toUpperCase();
    }

    function generateCertificate() {
      const div = document.createElement('div');
      div.className = 'certificate';
      div.innerHTML = `
        <div class="certificate-header">
          <h1>Certificate of Completion</h1>
          <p>Industrial Induction LMS</p>
        </div>
        <div class="certificate-body">
          <p>This is to certify that</p>
          <h2>${APP_STATE.currentUser.name}</h2>
          <p>has successfully completed the</p>
          <h3>${APP_STATE.currentModule.title}</h3>
          <p>training module with a score of ${APP_STATE.currentAttempt.score}%</p>
          <p>on ${new Date(APP_STATE.currentAttempt.timestamp).toLocaleDateString()}</p>
        </div>
        <div class="certificate-footer">
          <div>
            <p>Certificate ID: ${APP_STATE.currentAttempt.id}</p>
            <p>Employee ID: ${APP_STATE.currentUser.id}</p>
            <p>Department: ${APP_STATE.currentUser.department}</p>
          </div>
          <div class="qr-code">QR Code</div>
        </div>
      `;
      const win = window.open('', '_blank');
      win.document.write(`
        <html>
          <head>
            <title>Certificate - ${APP_STATE.currentUser.name}</title>
            <style>
              body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
              .certificate { border: 10px solid gold; padding: 2rem; max-width: 800px; margin: 0 auto; }
              h1 { color: #1e3c72; }
              h2 { color: #2a5298; margin: 1rem 0; }
              h3 { color: #4a6fc7; margin: 1rem 0; }
              .certificate-footer { display: flex; justify-content: space-between; margin-top: 2rem; }
              .qr-code { width: 120px; height: 120px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; }
              @media print {
                body { margin: 0; }
              }
            </style>
          </head>
          <body>${div.outerHTML}</body>
        </html>
      `);
      win.document.close();
      win.print();
    }

    function handleBackToModules() {
      if (APP_STATE.currentAttempt && APP_STATE.currentAttempt.passed) {
        showNotification('You have already completed this module.', 'warning');
        return;
      }

      trainingVideo.pause();
      trainingVideo.currentTime = 0;
      APP_STATE.videoFinished = false;
      APP_STATE.maxWatched = 0;

      if (APP_STATE.quizTimer) clearInterval(APP_STATE.quizTimer);
      quizForm.reset();
      quizResult.textContent = '';
      quizResult.className = 'quiz-result';
      quizTimer.textContent = '--:--';

      hideSection(njTraining);
      hideSection(njResult);
      showSection(njModuleSelect);
      updateProgressIndicator(3);
    }

    function handleAdminLogin(e) {
      e.preventDefault();
      const admin = APP_STATE.admins.find(a => a.username === adminUser.value && a.password === adminPass.value);
      if (!admin) {
        adminLoginError.textContent = 'Invalid username or password. Please try again.';
        return;
      }
      APP_STATE.adminLoggedIn = true;
      APP_STATE.currentAdmin = admin;
      admin.lastLogin = new Date().toISOString();
      localStorage.setItem('lms_admin_logged_in', 'true');
      localStorage.setItem('lms_current_admin', admin.username);
      localStorage.setItem('lms_admins', JSON.stringify(APP_STATE.admins));
      showAdminDashboard();
      showNotification('Admin login successful!', 'success');
    }

    function showAdminDashboard() {
      adminWelcome.textContent = `Welcome, ${APP_STATE.currentAdmin.username}`;
      showSection(adminDashboard);
      hideSection(adminLogin);
      switchAdminTab('overview');
      renderModuleList();
      renderResultsTable();
      renderAdminsTable();
    }

    function handleAdminLogoutClick() {
      APP_STATE.adminLoggedIn = false;
      APP_STATE.currentAdmin = null;
      localStorage.removeItem('lms_admin_logged_in');
      localStorage.removeItem('lms_current_admin');
      switchView('admin');
      showNotification('Logged out successfully.', 'success');
    }

    function switchAdminTab(tabName) {
      adminTabs.forEach(t => t.classList.toggle('admin-tab-active', t.dataset.tab === tabName));
      adminTabPanels.forEach(p => p.classList.toggle('hidden', p.id !== `admin-tab-${tabName}`));
      if (tabName === 'overview') updateAdminStats();
      if (tabName === 'results') renderResultsTable();
      if (tabName === 'admins') renderAdminsTable();
    }

    function updateAdminStats() {
      const totalUsers = new Set(APP_STATE.attempts.map(a => a.userId)).size;
      const passCount = APP_STATE.attempts.filter(a => a.passed).length;
      const failCount = APP_STATE.attempts.filter(a => !a.passed).length;
      const activeModules = APP_STATE.modules.length;

      statTotalUsers.textContent = totalUsers;
      statPassCount.textContent = passCount;
      statFailCount.textContent = failCount;
      statModules.textContent = activeModules;

      updateCharts();
    }

    function renderResultsTable() {
      resultsTableBody.innerHTML = '';
      APP_STATE.attempts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(a.timestamp).toLocaleString()}</td>
          <td>${a.userName}</td>
          <td>${a.userId}</td>
          <td>${a.userDept}</td>
          <td>${a.moduleTitle}</td>
          <td>${a.score}%</td>
          <td><span class="pass-badge ${a.passed ? 'pass' : 'fail'}">${a.passed ? 'PASS' : 'FAIL'}</span></td>
          <td>${a.id}</td>
        `;
        resultsTableBody.appendChild(tr);
      });
    }

    function renderAdminsTable() {
      const tbody = document.getElementById('adminsTableBody');
      tbody.innerHTML = '';
      APP_STATE.admins.forEach(a => {
        const lastLogin = a.lastLogin ? new Date(a.lastLogin).toLocaleString() : 'Never';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.username}</td>
          <td>${a.role}</td>
          <td>${lastLogin}</td>
          <td>
            ${a.username !== APP_STATE.currentAdmin.username
              ? `<button class="btn-secondary btn-small" onclick="deleteAdmin('${a.username}')">Delete</button>`
              : '<span class="badge badge-soft">Current</span>'}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function deleteAdmin(username) {
      if (!confirm(`Delete admin "${username}"?`)) return;
      APP_STATE.admins = APP_STATE.admins.filter(a => a.username !== username);
      localStorage.setItem('lms_admins', JSON.stringify(APP_STATE.admins));
      renderAdminsTable();
      showNotification('Admin deleted successfully.', 'success');
    }

    function handleAddAdmin(e) {
      e.preventDefault();
      const username = document.getElementById('newAdminUser').value;
      const password = document.getElementById('newAdminPass').value;
      const confirmPassword = document.getElementById('newAdminPassConfirm').value;
      const role = document.getElementById('newAdminRole').value;

      if (password !== confirmPassword) {
        showNotification('Passwords do not match!', 'error');
        return;
      }
      if (APP_STATE.admins.find(a => a.username === username)) {
        showNotification('Admin already exists!', 'error');
        return;
      }

      APP_STATE.admins.push({ username, password, role, lastLogin: null });
      localStorage.setItem('lms_admins', JSON.stringify(APP_STATE.admins));
      renderAdminsTable();
      addAdminForm.reset();
      showNotification('Admin added successfully!', 'success');
    }

    function handlePasswordChange(e) {
      e.preventDefault();
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;

      if (APP_STATE.currentAdmin.password !== currentPassword) {
        showNotification('Current password is incorrect!', 'error');
        return;
      }
      if (newPassword !== confirmNewPassword) {
        showNotification('New passwords do not match!', 'error');
        return;
      }

      APP_STATE.currentAdmin.password = newPassword;
      localStorage.setItem('lms_admins', JSON.stringify(APP_STATE.admins));
      changePasswordForm.reset();
      showNotification('Password changed successfully!', 'success');
    }

    function filterResultsTable() {
      const term = resultsSearch.value.toLowerCase();
      [...resultsTableBody.querySelectorAll('tr')].forEach(tr => {
        tr.style.display = tr.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    }

    function exportToExcel() {
      if (APP_STATE.attempts.length === 0) {
        showNotification('No data to export.', 'warning');
        return;
      }
      const data = APP_STATE.attempts.map(a => ({
        'Date/Time': new Date(a.timestamp).toLocaleString(),
        'Name': a.userName,
        'Emp ID': a.userId,
        'Department': a.userDept,
        'Module': a.moduleTitle,
        'Score': `${a.score}%`,
        'Pass/Fail': a.passed ? 'PASS' : 'FAIL',
        'Certificate ID': a.id
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Training Results');
      XLSX.writeFile(wb, 'Industrial_Induction_Results.xlsx');
      showNotification('Data exported successfully!', 'success');
    }

    async function handleAddModule(e) {
      e.preventDefault();
      const qs = [...questionsContainer.querySelectorAll('.question-set')];
      const questions = [];
      qs.forEach(set => {
        const text = set.querySelector('.question-text').value.trim();
        const correct = set.querySelector('.question-correct').value.trim();
        const others = set.querySelector('.question-others').value.trim();
        if (text && correct && others) {
          questions.push({
            text,
            options: [correct, ...others.split(',').map(o=>o.trim())],
            correct: 0
          });
        }
      });
      if (questions.length === 0) {
        showNotification('Please add at least one question.', 'warning');
        return;
      }

      const title = document.getElementById('modTitle').value.trim();
      const category = document.getElementById('modCategory').value.trim();
      let videoPath = document.getElementById('modVideoPath').value.trim();

      if (!videoPath) {
        const slug = title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
        videoPath = `videos/${slug}.mp4`;
      }

      const newModule = {
        id: generateModuleId(title),
        title,
        category,
        video: videoPath,
        thumbnail: '',
        passMark: parseInt(document.getElementById('modPassMark').value,10),
        quizTime: parseInt(document.getElementById('modQuizTime').value,10),
        questions
      };

      APP_STATE.modules.push(newModule);
      await saveModuleToSheet(newModule);

      addModuleForm.reset();
      document.getElementById('modPassMark').value = APP_STATE.settings.defaultPassMark;
      document.getElementById('modQuizTime').value = APP_STATE.settings.defaultQuizTime;
      questionsContainer.innerHTML = '';
      addQuestionSet();
      renderModuleList();
      showNotification('Module added successfully!', 'success');
    }

    function generateModuleId(title) {
      return title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
    }

    function editModule(moduleId) {
      const mod = APP_STATE.modules.find(m => m.id === moduleId);
      if (!mod) return;

      document.getElementById('modTitle').value = mod.title;
      document.getElementById('modCategory').value = mod.category;
      document.getElementById('modVideoPath').value = mod.video;
      document.getElementById('modPassMark').value = mod.passMark;
      document.getElementById('modQuizTime').value = mod.quizTime;

      questionsContainer.innerHTML = '';
      mod.questions.forEach((q, idx) => {
        addQuestionSet();
        const set = questionsContainer.children[idx];
        set.querySelector('.question-text').value = q.text;
        set.querySelector('.question-correct').value = q.options[0];
        set.querySelector('.question-others').value = q.options.slice(1).join(', ');
      });

      addModuleForm.scrollIntoView();
      const btn = addModuleForm.querySelector('button[type="submit"]');
      btn.textContent = 'Update Module';
      btn.onclick = async (e) => {
        e.preventDefault();
        await updateModule(moduleId);
      };
    }

    async function updateModule(moduleId) {
      const idx = APP_STATE.modules.findIndex(m => m.id === moduleId);
      if (idx === -1) return;

      const qs = [...questionsContainer.querySelectorAll('.question-set')];
      const questions = [];
      qs.forEach(set => {
        const text = set.querySelector('.question-text').value.trim();
        const correct = set.querySelector('.question-correct').value.trim();
        const others = set.querySelector('.question-others').value.trim();
        if (text && correct && others) {
          questions.push({
            text,
            options: [correct, ...others.split(',').map(o=>o.trim())],
            correct: 0
          });
        }
      });
      if (questions.length === 0) {
        showNotification('Please add at least one question.', 'warning');
        return;
      }

      const title = document.getElementById('modTitle').value.trim();
      const category = document.getElementById('modCategory').value.trim();
      let videoPath = document.getElementById('modVideoPath').value.trim();
      if (!videoPath) {
        const slug = title.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
        videoPath = `videos/${slug}.mp4`;
      }

      APP_STATE.modules[idx] = {
        ...APP_STATE.modules[idx],
        title,
        category,
        video: videoPath,
        passMark: parseInt(document.getElementById('modPassMark').value,10),
        quizTime: parseInt(document.getElementById('modQuizTime').value,10),
        questions
      };

      await updateModuleInSheet(APP_STATE.modules[idx]);

      addModuleForm.reset();
      questionsContainer.innerHTML = '';
      addQuestionSet();
      renderModuleList();

      const btn = addModuleForm.querySelector('button[type="submit"]');
      btn.textContent = 'Add Module';
      btn.onclick = null;
      showNotification('Module updated successfully!', 'success');
    }

    async function deleteModule(moduleId) {
      if (!confirm('Are you sure you want to delete this module?')) return;
      APP_STATE.modules = APP_STATE.modules.filter(m => m.id !== moduleId);
      await deleteModuleFromSheet(moduleId);
      renderModuleList();
      showNotification('Module deleted successfully!', 'success');
    }

    function handleColorChange(e) {
      const color = e.target.getAttribute('data-color');
      document.documentElement.style.setProperty('--primary-color', color);
      document.documentElement.style.setProperty('--secondary-color', color);
      colorOptions.forEach(o => o.classList.remove('active'));
      e.target.classList.add('active');
      APP_STATE.settings.themeColor = color;
      localStorage.setItem('lms_settings', JSON.stringify(APP_STATE.settings));
      updateCharts();
      showNotification('Theme color updated!', 'success');
    }

    function handleSystemSettings(e) {
      e.preventDefault();
      APP_STATE.settings.appName = document.getElementById('appName').value;
      APP_STATE.settings.appDescription = document.getElementById('appDescription').value;
      APP_STATE.settings.autoNextModule = document.getElementById('autoNextModule').value;
      APP_STATE.settings.defaultQuizTime = parseInt(document.getElementById('defaultQuizTime').value,10);
      APP_STATE.settings.defaultPassMark = parseInt(document.getElementById('defaultPassMark').value,10);
      localStorage.setItem('lms_settings', JSON.stringify(APP_STATE.settings));
      loadSettings();
      showNotification('Settings saved successfully!', 'success');
    }

    window.deleteAdmin = deleteAdmin;
    window.editModule = editModule;
    window.deleteModule = deleteModule;
  </script>
</body>
</html>